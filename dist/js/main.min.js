class Search {

    constructor() {}

    createInput() {
        let select = document.querySelectorAll('.modal-wrapper select')[0],
            input = document.createElement('input');
        input.id = 'search';
        input.placeholder = 'Поиск импульса...';
        select.insertAdjacentHTML('afterEnd', input.outerHTML);

    }

    search() {
        // Declare letiables
        let input, filter, i, txtValue, div, result;
        input = document.getElementById('search');
        filter = input.value.toUpperCase();
        result = document.getElementById("result");
        div = result.getElementsByTagName('div');

        // Loop through all list items, and hide those who don't match the search query
        for (i = 0; i < div.length; i++) {
            //a = div[i].getElementsByTagName("a")[0];
            txtValue = div[i].textContent || div[i].innerText;
            txtValue = txtValue.split('∟');

            if (txtValue[0].toUpperCase().indexOf(filter) > -1) {
                div[i].style.display = "";
            } else {
                div[i].style.display = "none";
            }
        }
    }

    listener() {
        let input = document.getElementById('search');
        input.addEventListener('input', e => this.search());

    }

    init() {
        this.createInput();
        this.listener();
    }
}
class Popup {
    constructor() {
        this.settings = {
            button: '#modal',
            maxWidth: 850,
            minWidth: 280,
            className: 'fade-and-drop',
        };
    }

    static extend() {
        for (let i = 1; i < arguments.length; i++) {
            for (let key in arguments[i]) {
                if (arguments[i].hasOwnProperty(key)) {
                    arguments[0][key] = arguments[i][key]
                }
            }
        }
        return arguments[0]
    }

    static $(el) {
        return document.querySelectorAll(el)[0];
    }

    close() {
        this.modal.className = this.modal.className.replace(" scotch-open", "");
        this.overlay.className = this.overlay.className.replace(" scotch-open", "");
        this.modal.addEventListener('transitionend', e => this.modal.parentNode.removeChild(this.modal), false);
        this.overlay.addEventListener('transitionend', e => {
            if (this.overlay.parentNode) this.overlay.parentNode.removeChild(this.overlay)}
            , false );
    }

    handlerModel() {
        this.closeButton.addEventListener('click', e => this.close(), false);
        this.overlay.addEventListener('click', e => this.close(), false);
    }

    handlerButton() {
        let button = Popup.$(this.settings.button);
        button.addEventListener('click', e => this.open(), false);
    }

    buildModel() {
        let contentHolder,
            docFrag;
        docFrag = document.createDocumentFragment();
        this.modal = document.createElement('div');
        this.closeButton = document.createElement('button');
        this.overlay = document.createElement("div");
        this.modal.className = 'scotch-modal ' + this.settings.className;
        this.modal.style.minWidth = this.settings.minWidth + 'px';
        this.modal.style.maxWidth = this.settings.maxWidth + 'px';
        this.closeButton.className = 'scotch-close close-button';
        this.closeButton.innerHTML = '&times;';
        this.modal.appendChild(this.closeButton);
        this.overlay.className = "scotch-overlay " + this.settings.className;
        docFrag.appendChild(this.overlay);
        contentHolder = document.createElement("div");
        contentHolder.className = "scotch-content";
        contentHolder.appendChild(this.createModal());
        this.modal.appendChild(contentHolder);
        docFrag.appendChild(this.modal);
        document.body.appendChild(docFrag);
    }

    open() {
        this.buildModel();
        window.App.search.init();
        this.handlerModel();
        window.getComputedStyle(this.modal).height;
        this.modal.className = this.modal.className + (this.modal.offsetHeight > window.innerHeight ? ' scotch-open scotch-anchored' : ' scotch-open');
        this.overlay.className = this.overlay.className + ' scotch-open';
        window.App.select.createElement();
    }

    createModal() {
        let frag = document.createDocumentFragment();
        let div = document.createElement('div');
        div.className = 'modal-wrapper';
        let h4 = document.createElement('h4');
        h4.innerText = this.settings.title;
        div.appendChild(h4);
        let p = document.createElement('p');
        p.innerHTML = this.settings.content;
        div.appendChild(p);
        let select = document.createElement('select');
        select.disabled = true;
        let option_default = document.createElement('option');
        option_default.innerText = 'Загрузка станций...';
        option_default.value = '0';
        select.appendChild(option_default);
        div.appendChild(select);
        let div_result = document.createElement('div');
        div_result.id = 'result';
        div.appendChild(div_result);
        let checkbox = document.createRange().createContextualFragment('<div class="check"><label class="container">Расширенный вид<input type="checkbox" name="extend" id="extend"><span class="checkmark"></span></label></div>');
        div.appendChild(checkbox);
        frag.appendChild(div);
        return frag;
    }

    init(opt) {
        this.settings = Popup.extend({}, this.settings, opt);
        this.handlerButton();
    }
}
class Select {

    constructor() {
        this.mnemo = [
            '20000',
            '10000',
            '10001',
            '40001',
            '40002',
            '90000',
            '90001',
        ];
    }

    ajax(opts) {
        return new Promise( (resolve, reject) => {
            var xhr = new XMLHttpRequest();
            xhr.open('GET', opts.url + '?table=' + opts.table + '&param=' + opts.param, true);

            xhr.onload = function() {
                if (this.status == 200) {
                    resolve(this.responseText);
                } else {
                    var error = new Error(this.statusText);
                    error.code = this.status;
                    reject(error);
                }
            };

            xhr.onerror = function() {
                reject(new Error("Network Error"));
            };

            xhr.send();
        } );
    }

    setMnemoText(data){
        let new_data = JSON.parse(JSON.stringify(data));
        let length = new_data.length;
        for(let i=0;i<length; i++){
            if(this.mnemo.includes(new_data[i].mnemo_id)) {
                new_data[i].place = 'Участок';
            } else {
                new_data[i].place = 'Станция';
            }
        }
        console.log(new_data);
        return new_data;
    }

    handlerCheck(){
        let check = document.querySelectorAll('input[name=extend]')[0];
        let info = document.getElementsByClassName('info');
        check.addEventListener('change', function() {
            if(this.checked) {
                for (let item of info) {
                    item.style.display = 'block';
                }
            } else {
                for (let item of info) {
                    item.style.display = 'none';
                }
            }
        });
    }

    static checked() {
        let el = document.querySelector('input[name=extend]');
        if (el.checked) {
            return 'block';
        } else {
            return 'none';
        }
    }

    showData(response) {
        let data = JSON.parse(response);
        if(data.hasOwnProperty('error')) {
            alert(data.error);
        }
        data = this.setMnemoText(data);
        let result = document.querySelectorAll('#result')[0];
        result.innerHTML = '';
        data.forEach(function (item) {
            let div = document.createElement('div');
            let sign = item.dev_desc == '1'?'Нет':'Да';
            div.innerHTML = item.sign + ' - ' + sign;
            div.innerHTML += `<span class="info" style="display: ${Select.checked()};">&angrt; id: ${item.val_id}, ip: ${item.interface}, id_shem: ${item.id_shem}, id_mnemo: ${item.mnemo_id}, signal: ${item.dev_desc}, ${item.place}</span>`;
            if(item.dev_desc == '0') {
                div.className ='alarm';
            }
            if(item.title !== null) {
                div.setAttribute('title', item.title);
            }
            result.appendChild(div);
        });
        this.handlerCheck();
    }

    getData(e) {
        let result = document.querySelectorAll('#result')[0];
        result.innerHTML = 'Загрузка импульсов...';
        document.getElementById('search').value = '';
        let data = this.ajax({
            url: 'php/getData.php',
            table: 'ts',
            param: e.target.value,
        });
        data.then(
            response => this.showData(response),
            error => console.log(`Rejected: ${error}`)
        );
    }

    getStations (opts) {
        let stations = this.ajax(opts);
        stations.then(
            response => this.createSelect(response),
            error => console.log(`Rejected: ${error}`)
        );
    }

    createSelect(response) {
        let data = JSON.parse(response);
        if(data.hasOwnProperty('error')) {
            alert(data.error);
        }
        let select = document.querySelectorAll('select')[0];
        select.disabled = false;
        select.options[0].text = 'Выберите станцию';
        data.forEach(function (item) {
            let option = document.createElement('option');
            option.value = item.id;
            option.innerText = item.sign;
            select.appendChild(option);
        });
        select.addEventListener('change', this.getData.bind(this));
    }

    createElement() {
        this.getStations({
            url: 'php/getData.php',
            table: 'kp',
            param: '',
        });


    }
}


window.App = {};

window.App.select = new Select();
window.App.search = new Search();

new Popup().init({
    button: '#modal-button',
    title: 'Импульсы ТС',
    content: '<b>Да</b> - есть сигнализация, <b>Нет</b> - нет сигнализации.'
});
