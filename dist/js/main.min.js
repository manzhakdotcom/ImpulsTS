"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}var Search=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"createInput",value:function(){var e=document.querySelectorAll(".modal-wrapper select")[0],t=document.createElement("input");t.id="search",t.placeholder="Поиск импульса...",e.insertAdjacentHTML("afterEnd",t.outerHTML)}},{key:"search",value:function(){var e,t,n;for(e=document.getElementById("search").value.toUpperCase(),n=document.getElementById("result").getElementsByTagName("div"),t=0;t<n.length;t++)-1<(n[t].textContent||n[t].innerText).split("∟")[0].toUpperCase().indexOf(e)?n[t].style.display="":n[t].style.display="none"}},{key:"listener",value:function(){var t=this;document.getElementById("search").addEventListener("input",function(e){return t.search()})}},{key:"init",value:function(){this.createInput(),this.listener()}}]),e}(),Popup=function(){function n(){_classCallCheck(this,n),this.settings={button:"#modal",maxWidth:850,minWidth:280,className:"fade-and-drop"}}return _createClass(n,[{key:"close",value:function(){var t=this;this.modal.className=this.modal.className.replace(" scotch-open",""),this.overlay.className=this.overlay.className.replace(" scotch-open",""),this.modal.addEventListener("transitionend",function(e){return t.modal.parentNode.removeChild(t.modal)},!1),this.overlay.addEventListener("transitionend",function(e){t.overlay.parentNode&&t.overlay.parentNode.removeChild(t.overlay)},!1)}},{key:"handlerModel",value:function(){var t=this;this.closeButton.addEventListener("click",function(e){return t.close()},!1),this.overlay.addEventListener("click",function(e){return t.close()},!1)}},{key:"handlerButton",value:function(){var t=this;n.$(this.settings.button).addEventListener("click",function(e){return t.open()},!1)}},{key:"buildModel",value:function(){var e,t;t=document.createDocumentFragment(),this.modal=document.createElement("div"),this.closeButton=document.createElement("button"),this.overlay=document.createElement("div"),this.modal.className="scotch-modal "+this.settings.className,this.modal.style.minWidth=this.settings.minWidth+"px",this.modal.style.maxWidth=this.settings.maxWidth+"px",this.closeButton.className="scotch-close close-button",this.closeButton.innerHTML="&times;",this.modal.appendChild(this.closeButton),this.overlay.className="scotch-overlay "+this.settings.className,t.appendChild(this.overlay),(e=document.createElement("div")).className="scotch-content",e.appendChild(this.createModal()),this.modal.appendChild(e),t.appendChild(this.modal),document.body.appendChild(t)}},{key:"open",value:function(){this.buildModel(),window.App.search.init(),this.handlerModel(),window.getComputedStyle(this.modal).height,this.modal.className=this.modal.className+(this.modal.offsetHeight>window.innerHeight?" scotch-open scotch-anchored":" scotch-open"),this.overlay.className=this.overlay.className+" scotch-open",window.App.select.createElement()}},{key:"createModal",value:function(){var e=document.createDocumentFragment(),t=document.createElement("div");t.className="modal-wrapper";var n=document.createElement("h4");n.innerText=this.settings.title,t.appendChild(n);var a=document.createElement("p");a.innerHTML=this.settings.content,t.appendChild(a);var r=document.createElement("select");r.disabled=!0;var o=document.createElement("option");o.innerText="Загрузка станций...",o.value="0",r.appendChild(o),t.appendChild(r);var i=document.createElement("div");i.id="result",t.appendChild(i);var l=document.createRange().createContextualFragment('<div class="check"><label class="container">Расширенный вид<input type="checkbox" name="extend" id="extend"><span class="checkmark"></span></label></div>');return t.appendChild(l),e.appendChild(t),e}},{key:"init",value:function(e){this.settings=n.extend({},this.settings,e),this.handlerButton()}}],[{key:"extend",value:function(e){for(var t=1;t<arguments.length;t++)for(var n in arguments[t])arguments[t].hasOwnProperty(n)&&(e[n]=arguments[t][n]);return e}},{key:"$",value:function(e){return document.querySelectorAll(e)[0]}}]),n}(),Select=function(){function r(){_classCallCheck(this,r),this.mnemo=["20000","10000","10001","40001","40002","90000","90001"]}return _createClass(r,[{key:"ajax",value:function(a){return new Promise(function(t,n){var e=new XMLHttpRequest;e.open("GET",a.url+"?table="+a.table+"&param="+a.param,!0),e.onload=function(){if(200==this.status)t(this.responseText);else{var e=new Error(this.statusText);e.code=this.status,n(e)}},e.onerror=function(){n(new Error("Network Error"))},e.send()})}},{key:"setMnemoText",value:function(e){for(var t=JSON.parse(JSON.stringify(e)),n=t.length,a=0;a<n;a++)this.mnemo.includes(t[a].mnemo_id)?t[a].place="Участок":t[a].place="Станция";return console.log(t),t}},{key:"handlerCheck",value:function(){var e=document.querySelectorAll("input[name=extend]")[0],d=document.getElementsByClassName("info");e.addEventListener("change",function(){if(this.checked){var e=!0,t=!1,n=void 0;try{for(var a,r=d[Symbol.iterator]();!(e=(a=r.next()).done);e=!0){a.value.style.display="block"}}catch(e){t=!0,n=e}finally{try{e||null==r.return||r.return()}finally{if(t)throw n}}}else{var o=!0,i=!1,l=void 0;try{for(var c,s=d[Symbol.iterator]();!(o=(c=s.next()).done);o=!0){c.value.style.display="none"}}catch(e){i=!0,l=e}finally{try{o||null==s.return||s.return()}finally{if(i)throw l}}}})}},{key:"showData",value:function(e){var t=JSON.parse(e);t.hasOwnProperty("error")&&alert(t.error),t=this.setMnemoText(t);var a=document.querySelectorAll("#result")[0];a.innerHTML="",t.forEach(function(e){var t=document.createElement("div"),n="1"==e.dev_desc?"Нет":"Да";t.innerHTML=e.sign+" - "+n,t.innerHTML+='<span class="info" style="display: '.concat(r.checked(),';">&angrt; id: ').concat(e.val_id,", ip: ").concat(e.interface,", id_shem: ").concat(e.id_shem,", id_mnemo: ").concat(e.mnemo_id,", signal: ").concat(e.dev_desc,", ").concat(e.place,"</span>"),"0"==e.dev_desc&&(t.className="alarm"),null!==e.title&&t.setAttribute("title",e.title),a.appendChild(t)}),this.handlerCheck()}},{key:"getData",value:function(e){var t=this;document.querySelectorAll("#result")[0].innerHTML="Загрузка импульсов...",document.getElementById("search").value="",this.ajax({url:"php/getData.php",table:"ts",param:e.target.value}).then(function(e){return t.showData(e)},function(e){return console.log("Rejected: ".concat(e))})}},{key:"getStations",value:function(e){var t=this;this.ajax(e).then(function(e){return t.createSelect(e)},function(e){return console.log("Rejected: ".concat(e))})}},{key:"createSelect",value:function(e){var t=JSON.parse(e);t.hasOwnProperty("error")&&alert(t.error);var n=document.querySelectorAll("select")[0];n.disabled=!1,n.options[0].text="Выберите станцию",t.forEach(function(e){var t=document.createElement("option");t.value=e.id,t.innerText=e.sign,n.appendChild(t)}),n.addEventListener("change",this.getData.bind(this))}},{key:"createElement",value:function(){this.getStations({url:"php/getData.php",table:"kp",param:""})}}],[{key:"checked",value:function(){return document.querySelector("input[name=extend]").checked?"block":"none"}}]),r}();window.App={},window.App.select=new Select,window.App.search=new Search,(new Popup).init({button:"#modal-button",title:"Импульсы ТС",content:"<b>Да</b> - есть сигнализация, <b>Нет</b> - нет сигнализации."});